---
import { Tabs, TabItem, Code } from "@astrojs/starlight/components";

interface Props {
  framework: "react" | "solid"
  component: string
  story?: string
  height?: string
  code?: string
}

const { framework, component, story = "default", height = "400px", code } = Astro.props

const port = framework === "react" ? "4848" : "4849"
const storyPath = story.toLowerCase().replace(/\s+/g, "-")
const storyId = `${framework}-ui-${component}--${storyPath}`

// Detect environment and set appropriate base URL
const isProd = import.meta.env.PROD || import.meta.env.MODE === 'production'
const baseUrl = isProd
  ? `https://devx-op.github.io/arkitect-ui/${framework}-storybook/iframe.html?id=${storyId}&viewMode=story`
  : `http://localhost:${port}/iframe.html?id=${storyId}&viewMode=story`

const storybookBaseUrl = isProd
  ? `https://devx-op.github.io/arkitect-ui/${framework}-storybook`
  : `http://localhost:${port}`
---

<div class="component-preview-wrapper">
  <Tabs>
    <TabItem label="Preview">
      <div 
        class="component-preview rounded-lg border border-border overflow-hidden bg-background" 
        data-preview-framework={framework} 
        data-preview-story={storyId}
        data-preview-port={port}
        style={`height: ${height}`}
      >
        <div class="preview-header flex items-center justify-between px-4 py-2 bg-muted border-b border-border">
          <span class="text-sm font-medium text-muted-foreground">Preview</span>
          <span class="text-xs text-muted-foreground">{framework}</span>
        </div>
        <iframe
          data-preview-iframe
          data-framework={framework}
          data-storybook-base={storybookBaseUrl}
          src={baseUrl}
          width="100%"
          height="100%"
          class="border-0"
          title={`${component} ${story} preview`}
          loading="lazy"
        />
      </div>
    </TabItem>
    {code && (
      <TabItem label="Usage">
        <Code code={code} lang="tsx" />
      </TabItem>
    )}
  </Tabs>
</div>

<script>
  // Storage keys (must match tweakcn-switcher in docs)
  const THEME_STORAGE_KEY = 'tweakcn-switcher-theme';
  const MODE_STORAGE_KEY = 'tweakcn-switcher-mode';
  
  // Function to get current mode from localStorage or document
  function getCurrentMode() {
    if (typeof localStorage !== 'undefined') {
      const savedMode = localStorage.getItem(MODE_STORAGE_KEY);
      if (savedMode) return savedMode;
    }
    return document.documentElement.classList.contains('dark') ? 'dark' : 'light';
  }
  
  // Function to get current theme from localStorage
  function getCurrentTheme() {
    if (typeof localStorage === 'undefined') return 'default';
    const themeData = localStorage.getItem(THEME_STORAGE_KEY);
    if (themeData) {
      try {
        const theme = JSON.parse(themeData);
        // The theme is stored as { url, mode, name }
        // Extract theme ID from name (e.g., "Catppuccin" -> "Catppuccin")
        if (theme.name) {
          return theme.name;
        }
        // Fallback: extract from URL (e.g., "https://tweakcn.com/r/themes/catppuccin.json" -> "catppuccin")
        if (theme.url) {
          const match = theme.url.match(/\/([^/]+)\.json$/);
          if (match) {
            return match[1];
          }
        }
        return 'default';
      } catch {
        return 'default';
      }
    }
    return 'default';
  }
  
  // Function to build iframe URL with mode and theme
  function buildIframeUrl(baseUrl: string, mode: string, theme: string) {
    // Check if URL already has globals parameter
    if (baseUrl.includes('&globals=')) {
      // Replace existing globals
      return baseUrl.replace(/globals=[^&]*/, `globals=theme:${theme};mode:${mode}`);
    } else {
      // Add new globals parameter
      return `${baseUrl}&globals=theme:${theme};mode:${mode}`;
    }
  }
  
  // Get Storybook base URL from iframe data attribute
  function getStorybookBaseUrl(iframe: HTMLIFrameElement): string {
    // Use the data attribute set during server-side rendering
    const baseFromData = iframe.getAttribute('data-storybook-base');
    if (baseFromData) {
      return baseFromData;
    }

    // Fallback: detect from src
    const framework = iframe.getAttribute('data-framework');
    const isLocal = iframe.getAttribute('src')?.includes('localhost') ?? false;

    if (isLocal) {
      const port = framework === 'react' ? '4848' : '4849';
      return `http://localhost:${port}`;
    } else {
      return `https://devx-op.github.io/arkitect-ui/${framework}-storybook`;
    }
  }

  // Function to update iframe src with current theme
  function updatePreviewThemes() {
    const mode = getCurrentMode();
    const theme = getCurrentTheme();

    document.querySelectorAll<HTMLIFrameElement>('[data-preview-iframe]').forEach((iframe) => {
      const currentSrc = iframe.getAttribute('src') || '';
      const baseUrl = currentSrc.split('&globals=')[0];
      const newSrc = buildIframeUrl(baseUrl, mode, theme);

      if (currentSrc !== newSrc) {
        iframe.setAttribute('src', newSrc);
      }

      // Also send postMessage for real-time updates without reload
      const storybookBase = getStorybookBaseUrl(iframe);

      try {
        iframe.contentWindow?.postMessage({
          type: 'THEME_CHANGE',
          theme: theme,
          mode: mode
        }, storybookBase);
      } catch (e) {
        // Ignore cross-origin errors during initial load
      }
    });
  }
  
  // Update on initial load
  updatePreviewThemes();
  
  // Watch for theme changes (dark/light mode)
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'class') {
        updatePreviewThemes();
      }
    });
  });
  
  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['class']
  });
  
  // Watch for theme changes in localStorage (from other tabs)
  window.addEventListener('storage', (e) => {
    if (e.key === THEME_STORAGE_KEY || e.key === MODE_STORAGE_KEY) {
      updatePreviewThemes();
    }
  });

  // Listen for custom theme change events from tweakcn-switcher (same tab)
  window.addEventListener('tweakcn-theme-change', () => {
    updatePreviewThemes();
  });

  // Also check periodically for theme changes (backup)
  setInterval(updatePreviewThemes, 1000);
</script>

<style>
  .component-preview-wrapper {
    margin: 1rem 0;
  }
  
  .component-preview {
    display: flex;
    flex-direction: column;
  }
  
  .component-preview iframe {
    flex: 1;
    min-height: 0;
  }
  
  .preview-header {
    background-color: hsl(var(--muted));
    flex-shrink: 0;
  }
</style>
