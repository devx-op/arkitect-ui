---
interface Props {
  framework: "react" | "solid"
  component: string
  story?: string
  height?: string
}

const { framework, component, story = "default", height = "400px" } = Astro.props

const port = framework === "react" ? "4848" : "4849"
const storyPath = story.toLowerCase().replace(/\s+/g, "-")
const storyId = `${framework}-ui-${component}--${storyPath}`
const baseUrl = `http://localhost:${port}/iframe.html?id=${storyId}&viewMode=story`
---

<div 
  class="component-preview rounded-lg border border-border overflow-hidden bg-background" 
  data-preview-framework={framework} 
  data-preview-story={storyId}
  data-preview-port={port}
>
  <div class="preview-header flex items-center justify-between px-4 py-2 bg-muted border-b border-border">
    <span class="text-sm font-medium text-muted-foreground">Preview</span>
    <span class="text-xs text-muted-foreground">{framework}</span>
  </div>
  <iframe
    data-preview-iframe
    data-framework={framework}
    src={baseUrl}
    width="100%"
    height={height}
    class="border-0"
    title={`${component} ${story} preview`}
    loading="lazy"
  />
</div>

<script>
  // Storage keys (must match tweakcn-switcher in docs)
  const THEME_STORAGE_KEY = 'tweakcn-switcher-theme';
  const MODE_STORAGE_KEY = 'tweakcn-switcher-mode';
  
  // Function to get current mode from localStorage or document
  function getCurrentMode() {
    if (typeof localStorage !== 'undefined') {
      const savedMode = localStorage.getItem(MODE_STORAGE_KEY);
      if (savedMode) return savedMode;
    }
    return document.documentElement.classList.contains('dark') ? 'dark' : 'light';
  }
  
  // Function to get current theme from localStorage
  function getCurrentTheme() {
    if (typeof localStorage === 'undefined') return 'default';
    const themeData = localStorage.getItem(THEME_STORAGE_KEY);
    if (themeData) {
      try {
        const theme = JSON.parse(themeData);
        // The theme is stored as { url, mode, name }
        // Extract theme ID from name (e.g., "Catppuccin" -> "Catppuccin")
        if (theme.name) {
          return theme.name;
        }
        // Fallback: extract from URL (e.g., "https://tweakcn.com/r/themes/catppuccin.json" -> "catppuccin")
        if (theme.url) {
          const match = theme.url.match(/\/([^/]+)\.json$/);
          if (match) {
            return match[1];
          }
        }
        return 'default';
      } catch {
        return 'default';
      }
    }
    return 'default';
  }
  
  // Function to build iframe URL with mode and theme
  function buildIframeUrl(baseUrl: string, mode: string, theme: string) {
    // Check if URL already has globals parameter
    if (baseUrl.includes('&globals=')) {
      // Replace existing globals
      return baseUrl.replace(/globals=[^&]*/, `globals=theme:${theme};mode:${mode}`);
    } else {
      // Add new globals parameter
      return `${baseUrl}&globals=theme:${theme};mode:${mode}`;
    }
  }
  
  // Function to update iframe src with current theme
  function updatePreviewThemes() {
    const mode = getCurrentMode();
    const theme = getCurrentTheme();
    
    document.querySelectorAll<HTMLIFrameElement>('[data-preview-iframe]').forEach((iframe) => {
      const currentSrc = iframe.getAttribute('src') || '';
      const baseUrl = currentSrc.split('&globals=')[0];
      const newSrc = buildIframeUrl(baseUrl, mode, theme);

      if (currentSrc !== newSrc) {
        iframe.setAttribute('src', newSrc);
      }

      // Also send postMessage for real-time updates without reload
      const framework = iframe.getAttribute('data-framework');
      const port = framework === 'react' ? '4848' : '4849';

      try {
        iframe.contentWindow?.postMessage({
          type: 'THEME_CHANGE',
          theme: theme,
          mode: mode
        }, `http://localhost:${port}`);
      } catch (e) {
        // Ignore cross-origin errors during initial load
      }
    });
  }
  
  // Update on initial load
  updatePreviewThemes();
  
  // Watch for theme changes (dark/light mode)
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'class') {
        updatePreviewThemes();
      }
    });
  });
  
  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['class']
  });
  
  // Watch for theme changes in localStorage (from other tabs)
  window.addEventListener('storage', (e) => {
    if (e.key === THEME_STORAGE_KEY || e.key === MODE_STORAGE_KEY) {
      updatePreviewThemes();
    }
  });

  // Listen for custom theme change events from tweakcn-switcher (same tab)
  window.addEventListener('tweakcn-theme-change', () => {
    updatePreviewThemes();
  });

  // Also check periodically for theme changes (backup)
  setInterval(updatePreviewThemes, 1000);
</script>

<style>
  .component-preview {
    margin: 1rem 0;
  }
  
  .preview-header {
    background-color: hsl(var(--muted));
  }
</style>
